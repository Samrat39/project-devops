name: microservices-ci-promotion

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
# ------------------------------------------------
# 1️⃣ BUILD + TEST
# ------------------------------------------------
  build-test:
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        service: [productcatalog]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Build & Test
        run: |
          cd ultimate-devops-project-demo/src/${{ matrix.service }}
          go mod tidy
          go build -o ${{ matrix.service }}
          go test ./...

# ------------------------------------------------
# 2️⃣ DOCKER BUILD & PUSH
# ------------------------------------------------
  docker:
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    needs: build-test
    timeout-minutes: 20

    strategy:
      matrix:
        service: [productcatalog, frontendproxy]

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build & Push Image
        uses: docker/build-push-action@v6
        with:
          context: ultimate-devops-project-demo/src/${{ matrix.service }}
          file: ultimate-devops-project-demo/src/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}:${{ github.sha }}

# ------------------------------------------------
# 3️⃣ DEPLOY TO DEV (AUTO)
# ------------------------------------------------
  deploy-dev:
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tag (DEV)
        run: |
          for service in productcatalog frontendproxy; do
            sed -i "s/tag:.*/tag: \"${{ github.sha }}\"/" apps/$service/values.yaml
          done

      - name: Commit DEV
        run: |
          git config user.name "ci-bot"
          git config user.email "ci@bot.com"
          git pull --rebase origin main || true
          git add apps/*/values.yaml
          git commit -m "dev: deploy ${{ github.sha }} [skip-ci]" || echo "No changes"
          git push

# ------------------------------------------------
# 4️⃣ HEALTH CHECK (DEV)
# ------------------------------------------------
  health-check-dev:
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    needs: deploy-dev
    timeout-minutes: 15

    steps:
      - name: Install Argo CD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Wait for DEV to be Healthy
        run: |
          argocd login $ARGOCD_SERVER \
            --auth-token $ARGOCD_TOKEN \
            --insecure

          argocd app wait ecommerce-dev \
            --sync \
            --health \
            --timeout 600
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN: ${{ secrets.ARGOCD_TOKEN }}

# ------------------------------------------------
# 5️⃣ PROMOTE TO STAGING (AUTO)
# ------------------------------------------------
  promote-staging:
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    needs: health-check-dev

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote to STAGING
        run: |
          sed -i "s/tag:.*/tag: \"${{ github.sha }}\"/" env/staging.yaml

      - name: Commit STAGING
        run: |
          git config user.name "ci-bot"
          git config user.email "ci@bot.com"
          git pull --rebase origin main || true
          git add env/staging.yaml
          git commit -m "staging: promote ${{ github.sha }} [skip-ci]" || echo "No changes"
          git push

# ------------------------------------------------
# 6️⃣ PROMOTE TO PROD (MANUAL)
# ------------------------------------------------
  promote-prod:
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    needs: promote-staging
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote to PROD
        run: |
          sed -i "s/tag:.*/tag: \"${{ github.sha }}\"/" env/prod.yaml

      - name: Commit PROD
        run: |
          git config user.name "ci-bot"
          git config user.email "ci@bot.com"
          git pull --rebase origin main || true
          git add env/prod.yaml
          git commit -m "prod: promote ${{ github.sha }} [skip-ci]" || echo "No changes"
          git push